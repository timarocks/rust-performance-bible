name: PR Benchmark Check

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'book/001-memory-is-not-free/**'
      - '.github/workflows/pr-benchmark.yml'
      - 'Cargo.toml'

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  benchmark-check:
    name: Performance Impact Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: ". -> target"
    
    - name: Run baseline benchmarks
      run: |
        git checkout ${{ github.event.pull_request.base.sha }}
        cd book/001-memory-is-not-free
        cargo bench -- --save-baseline pr-base
    
    - name: Run PR benchmarks
      run: |
        git checkout ${{ github.event.pull_request.head.sha }}
        cd book/001-memory-is-not-free
        cargo bench -- --baseline pr-base --output-format bencher | tee pr-bench-output.txt
    
    - name: Parse benchmark results
      id: bench
      run: |
        # Extract performance changes
        cat benchmarks/pr-bench-output.txt | grep -E "(\+|-)[0-9]+\.[0-9]+%" > perf-summary.txt || true
        
        # Check for regressions
        if grep -E "\+[0-9]+\.[0-9]+%" perf-summary.txt > /dev/null; then
          echo "regression=true" >> $GITHUB_OUTPUT
        else
          echo "regression=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Comment on PR
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const perfSummary = fs.readFileSync('perf-summary.txt', 'utf8');
          const hasRegression = '${{ steps.bench.outputs.regression }}' === 'true';
          
          const icon = hasRegression ? '⚠️' : '✅';
          const status = hasRegression ? 'Performance Regression Detected' : 'Performance Check Passed';
          
          const body = `## ${icon} Benchmark Results: ${status}
          
          <details>
          <summary>Click to see detailed benchmark comparison</summary>
          
          \`\`\`
          ${perfSummary || 'No significant performance changes detected.'}
          \`\`\`
          
          </details>
          
          ${hasRegression ? '**Please review the performance impact before merging.**' : ''}
          
          ---
          *Benchmarks run on Ubuntu latest. Results may vary on different hardware.*
          *See [Benchmark Algorithm](../benchmarks/BENCHMARK_ALGORITHM.md) for methodology.*`;
          
          // Find existing comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('Benchmark Results:')
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }
    
    - name: Fail if regression
      if: steps.bench.outputs.regression == 'true'
      run: |
        echo "Performance regression detected. Please address before merging."
        exit 1